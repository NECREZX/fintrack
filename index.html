<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FinTrack - Pencatatan Keuangan Pribadi</title>

    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#6a1b9a" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
      :root {
        --primary-color: #4361ee;
        --primary-dark: #3a56d4;
        --secondary-color: #3f37c9;
        --success-color: #4cc9f0;
        --danger-color: #f72585;
        --warning-color: #f8961e;
        --light-color: #f8f9fa;
        --dark-color: #212529;
        --gray-color: #6c757d;
        --border-radius: 12px;
        --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        --transition: all 0.3s ease;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Poppins", sans-serif;
      }

      body {
        background-color: #f5f7ff;
        color: var(--dark-color);
        line-height: 1.6;
        min-height: 100dvh;
        padding-bottom: 70px;
      }

      .app-container {
        display: flex;
        flex-direction: column;
        min-height: 100dvh;
        max-width: 1400px;
        margin: 0 auto;
      }

      /* Header Styles */
      header {
        background-color: white;
        padding: 1rem 1.5rem;
        box-shadow: var(--box-shadow);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .logo i {
        color: var(--primary-color);
        font-size: 1.8rem;
      }

      .logo h1 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-color);
      }

      .user-profile {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .account-selector {
        padding: 0.5rem 1rem;
        border-radius: var(--border-radius);
        border: 1px solid #ddd;
        background-color: white;
        font-weight: 500;
        cursor: pointer;
      }

      .theme-toggle {
        background: none;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
        color: var(--gray-color);
      }

      /* Content Area */
      .content-area {
        flex: 1;
        padding: 1.5rem;
        overflow-y: auto;
      }

      .page {
        display: none;
      }

      .page.active {
        display: block;
        animation: fadeIn 0.5s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .page-header {
        margin-bottom: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .page-title {
        font-size: 1.8rem;
        font-weight: 600;
        color: var(--dark-color);
      }

      .btn {
        padding: 0.6rem 1.2rem;
        border-radius: var(--border-radius);
        border: none;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
      }

      .btn-primary {
        background-color: var(--primary-color);
        color: white;
      }

      .btn-primary:hover {
        background-color: var(--primary-dark);
      }

      .btn-success {
        background-color: var(--success-color);
        color: white;
      }

      .btn-danger {
        background-color: var(--danger-color);
        color: white;
      }

      /* Floating Action Button */
      .fab {
        position: fixed;
        bottom: 90px;
        right: 20px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background-color: var(--primary-color);
        color: white;
        border: none;
        box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        z-index: 1000;
        transition: var(--transition);
      }

      .fab:hover {
        background-color: var(--primary-dark);
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(67, 97, 238, 0.4);
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        justify-content: center;
        align-items: center;
        padding: 1rem;
      }

      .modal-content {
        background-color: white;
        border-radius: var(--border-radius);
        padding: 2rem;
        box-shadow: var(--box-shadow);
        width: 100%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        animation: modalFadeIn 0.3s ease;
      }

      @keyframes modalFadeIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }

      .modal-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--dark-color);
      }

      .close-modal {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--gray-color);
      }

      .close-modal:hover {
        color: var(--danger-color);
      }

      .color-picker {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 0.5rem;
      }

      .color-option {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        cursor: pointer;
        border: 3px solid transparent;
        transition: var(--transition);
      }

      .color-option:hover {
        transform: scale(1.1);
      }

      .color-option.selected {
        border-color: var(--dark-color);
      }

      .modal-actions {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
        justify-content: flex-end;
      }

      /* Dashboard Cards */
      .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .stat-card {
        background-color: white;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        box-shadow: var(--box-shadow);
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
      }

      .balance-icon {
        background-color: var(--primary-color);
      }

      .income-icon {
        background-color: var(--success-color);
      }

      .expense-icon {
        background-color: var(--danger-color);
      }

      .stat-info h3 {
        font-size: 0.9rem;
        color: var(--gray-color);
        margin-bottom: 5px;
      }

      .stat-value {
        font-size: 1.8rem;
        font-weight: 700;
      }

      /* Charts */
      .charts-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .chart-card {
        background-color: white;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        box-shadow: var(--box-shadow);
      }

      .chart-title {
        font-size: 1.2rem;
        margin-bottom: 1rem;
        color: var(--dark-color);
      }

      .chart-container {
        height: 250px;
        position: relative;
      }

      /* Tables */
      .table-container {
        background-color: white;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        box-shadow: var(--box-shadow);
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid #eee;
      }

      th {
        font-weight: 600;
        color: var(--primary-color);
      }

      .transaction-type {
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
      }

      .type-income {
        background-color: rgba(76, 201, 240, 0.2);
        color: var(--success-color);
      }

      .type-expense {
        background-color: rgba(247, 37, 133, 0.2);
        color: var(--danger-color);
      }

      .action-buttons {
        display: flex;
        gap: 10px;
      }

      .btn-icon {
        padding: 0.4rem;
        border-radius: 5px;
        background: none;
        border: 1px solid #ddd;
        cursor: pointer;
        color: var(--gray-color);
      }

      .btn-icon:hover {
        background-color: #f5f5f5;
      }

      /* Forms */
      .form-container {
        background-color: white;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        box-shadow: var(--box-shadow);
        max-width: 600px;
        margin: 0 auto;
      }

      .form-group {
        margin-bottom: 1.2rem;
      }

      label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
      }

      .form-control {
        width: 100%;
        padding: 0.8rem 1rem;
        border-radius: var(--border-radius);
        border: 1px solid #ddd;
        font-size: 1rem;
        transition: var(--transition);
      }

      .form-control:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
      }

      .radio-group {
        display: flex;
        gap: 1.5rem;
        margin-top: 0.5rem;
      }

      .radio-option {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .radio-option input[type="radio"] {
        accent-color: var(--primary-color);
      }

      /* Filter Section */
      .filter-section {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
      }

      .filter-select {
        padding: 0.5rem 1rem;
        border-radius: var(--border-radius);
        border: 1px solid #ddd;
        background-color: white;
        min-width: 150px;
      }

      /* Account Cards */
      .accounts-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.5rem;
      }

      .account-card {
        background-color: white;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        box-shadow: var(--box-shadow);
        transition: var(--transition);
        border: 2px solid transparent;
      }

      .account-card.active {
        border-color: var(--primary-color);
      }

      .account-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .account-name {
        font-size: 1.2rem;
        font-weight: 600;
      }

      .account-balance {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
      }

      /* Bottom Navigation */
      .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: white;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        display: flex;
        justify-content: space-around;
        padding: 0.5rem 0;
        height: 70px;
      }

      .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        flex: 1;
        text-decoration: none;
        color: var(--gray-color);
        transition: var(--transition);
        padding: 0.5rem;
        border: none;
        background: none;
        cursor: pointer;
      }

      .nav-item.active {
        color: var(--primary-color);
      }

      .nav-icon {
        font-size: 1.2rem;
        margin-bottom: 0.3rem;
      }

      .nav-text {
        font-size: 0.7rem;
        font-weight: 500;
      }

      /* Sidebar for Desktop */
      @media (min-width: 769px) {
        .bottom-nav {
          display: none;
        }

        body {
          padding-bottom: 0;
        }

        .main-content {
          display: flex;
        }

        .sidebar {
          width: 250px;
          background-color: white;
          padding: 1.5rem 0;
          box-shadow: var(--box-shadow);
          display: flex;
          flex-direction: column;
        }

        .nav-menu {
          list-style: none;
          flex: 1;
        }

        .nav-item-desktop {
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 1rem 1.5rem;
          color: var(--dark-color);
          text-decoration: none;
          transition: var(--transition);
          border-left: 4px solid transparent;
          cursor: pointer;
          background: none;
          border: none;
          width: 100%;
          text-align: left;
          font-size: 1rem;
        }

        .nav-item-desktop:hover,
        .nav-item-desktop.active {
          background-color: rgba(67, 97, 238, 0.1);
          color: var(--primary-color);
          border-left-color: var(--primary-color);
        }

        .nav-item-desktop i {
          width: 20px;
          text-align: center;
        }

        .content-area {
          flex: 1;
          padding: 1.5rem;
          overflow-y: auto;
        }

        .fab {
          bottom: 30px;
          right: 30px;
          width: 70px;
          height: 70px;
          font-size: 2rem;
        }
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .stats-cards {
          grid-template-columns: 1fr;
        }

        .charts-container {
          grid-template-columns: 1fr;
        }

        .page-header {
          flex-direction: column;
          align-items: flex-start;
        }

        .content-area {
          padding: 1rem;
        }

        .nav-text {
          font-size: 0.65rem;
        }

        .sidebar {
          display: none;
        }

        .filter-section {
          flex-direction: column;
        }

        .filter-select {
          width: 100%;
        }

        .modal-content {
          padding: 1.5rem;
          margin: 1rem;
        }
      }

      /* Dark Theme */
      .dark-theme {
        --light-color: #121826;
        --dark-color: #f8f9fa;
        background-color: #0f1521;
        color: #f8f9fa;
      }

      .dark-theme header,
      .dark-theme .sidebar,
      .dark-theme .stat-card,
      .dark-theme .chart-card,
      .dark-theme .table-container,
      .dark-theme .form-container,
      .dark-theme .account-card,
      .dark-theme .bottom-nav,
      .dark-theme .modal-content {
        background-color: #1a2235;
        color: #f8f9fa;
      }

      .dark-theme .form-control,
      .dark-theme .filter-select,
      .dark-theme .account-selector {
        background-color: #25304a;
        border-color: #364155;
        color: #f8f9fa;
      }

      .dark-theme th,
      .dark-theme td {
        border-bottom-color: #364155;
      }

      .dark-theme .btn-icon {
        border-color: #364155;
      }

      .dark-theme .btn-icon:hover {
        background-color: #25304a;
      }

      .dark-theme .nav-item {
        color: #a0aec0;
      }

      .dark-theme .nav-item.active {
        color: var(--primary-color);
      }

      .dark-theme .color-option.selected {
        border-color: #f8f9fa;
      }

      .dark-theme .fab {
        background-color: var(--primary-color);
      }

      /* Default = MOBILE */
      .sidebar {
        display: none !important;
      }

      .bottom-nav {
        display: flex !important;
      }

      /* Desktop */
      @media (min-width: 769px) {
        .sidebar {
          display: flex !important;
        }

        .bottom-nav {
          display: none !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <!-- Header -->
      <header>
        <div class="logo">
          <i class="fas fa-chart-line"></i>
          <h1>FinTrack</h1>
        </div>
        <div class="user-profile">
          <select class="account-selector" id="accountSelector">
            <option value="default">Akun Utama</option>
          </select>
          <button class="theme-toggle" id="themeToggle">
            <i class="fas fa-moon"></i>
          </button>
        </div>
      </header>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Sidebar for Desktop -->
        <nav class="sidebar" id="desktopSidebar">
          <ul class="nav-menu">
            <li>
              <button class="nav-item-desktop active" data-page="dashboard">
                <i class="fas fa-home"></i>
                <span>Beranda</span>
              </button>
            </li>
            <li>
              <button class="nav-item-desktop" data-page="transactions">
                <i class="fas fa-history"></i>
                <span>Riwayat Transaksi</span>
              </button>
            </li>
            <li>
              <button class="nav-item-desktop" data-page="accounts">
                <i class="fas fa-wallet"></i>
                <span>Kelola Akun</span>
              </button>
            </li>
            <li>
              <button class="nav-item-desktop" data-page="reports">
                <i class="fas fa-chart-pie"></i>
                <span>Laporan & Statistik</span>
              </button>
            </li>
            <li>
              <button class="nav-item-desktop" data-page="settings">
                <i class="fas fa-cog"></i>
                <span>Pengaturan</span>
              </button>
            </li>
          </ul>
        </nav>

        <!-- Content Area -->
        <main class="content-area">
          <!-- Dashboard Page -->
          <section id="dashboard" class="page active">
            <div class="page-header">
              <h2 class="page-title">Dashboard Keuangan</h2>
              <div class="current-month" id="currentMonth">Januari 2023</div>
            </div>

            <!-- Stats Cards -->
            <div class="stats-cards">
              <div class="stat-card">
                <div class="stat-icon balance-icon">
                  <i class="fas fa-wallet"></i>
                </div>
                <div class="stat-info">
                  <h3>Total Saldo</h3>
                  <div class="stat-value" id="totalBalance">Rp 0</div>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon income-icon">
                  <i class="fas fa-arrow-down"></i>
                </div>
                <div class="stat-info">
                  <h3>Total Pemasukan</h3>
                  <div class="stat-value" id="totalIncome">Rp 0</div>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon expense-icon">
                  <i class="fas fa-arrow-up"></i>
                </div>
                <div class="stat-info">
                  <h3>Total Pengeluaran</h3>
                  <div class="stat-value" id="totalExpense">Rp 0</div>
                </div>
              </div>
            </div>

            <!-- Charts -->
            <div class="charts-container">
              <div class="chart-card">
                <h3 class="chart-title">
                  Pemasukan vs Pengeluaran (Bulan Ini)
                </h3>
                <div class="chart-container">
                  <canvas id="barChart"></canvas>
                </div>
              </div>
              <div class="chart-card">
                <h3 class="chart-title">Pengeluaran per Kategori</h3>
                <div class="chart-container">
                  <canvas id="pieChart"></canvas>
                </div>
              </div>
            </div>

            <!-- Recent Transactions -->
            <div class="page-header">
              <h3 class="page-title">Transaksi Terbaru</h3>
              <button class="btn btn-primary" id="viewAllTransactions">
                <i class="fas fa-list"></i>
                Lihat Semua
              </button>
            </div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Tanggal</th>
                    <th>Kategori</th>
                    <th>Deskripsi</th>
                    <th>Jumlah</th>
                    <th>Tipe</th>
                  </tr>
                </thead>
                <tbody id="recentTransactions">
                  <!-- Recent transactions will be loaded here -->
                </tbody>
              </table>
            </div>
          </section>

          <!-- Transactions History Page -->
          <section id="transactions" class="page">
            <div class="page-header">
              <h2 class="page-title">Riwayat Transaksi</h2>
              <div class="filter-section">
                <select class="filter-select" id="transactionTypeFilter">
                  <option value="all">Semua Tipe</option>
                  <option value="income">Pemasukan</option>
                  <option value="expense">Pengeluaran</option>
                </select>
                <select class="filter-select" id="categoryFilter">
                  <option value="all">Semua Kategori</option>
                </select>
                <input type="month" class="filter-select" id="monthFilter" />
                <button class="btn btn-primary" id="filterButton">
                  <i class="fas fa-filter"></i>
                  Filter
                </button>
              </div>
            </div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Tanggal</th>
                    <th>Kategori</th>
                    <th>Deskripsi</th>
                    <th>Jumlah</th>
                    <th>Tipe</th>
                    <th>Aksi</th>
                  </tr>
                </thead>
                <tbody id="transactionsTable">
                  <!-- Transactions will be loaded here -->
                </tbody>
              </table>
            </div>
          </section>

          <!-- Accounts Page -->
          <section id="accounts" class="page">
            <div class="page-header">
              <h2 class="page-title">Kelola Akun</h2>
              <button
                class="btn btn-primary"
                id="addAccountBtn"
                onclick="showModal('addAccountModal')"
              >
                <i class="fas fa-plus"></i>
                Tambah Akun Baru
              </button>
            </div>
            <div class="accounts-container" id="accountsContainer">
              <!-- Account cards will be loaded here -->
            </div>
          </section>

          <!-- Reports Page -->
          <section id="reports" class="page">
            <div class="page-header">
              <h2 class="page-title">Laporan & Statistik</h2>
              <div class="filter-section">
                <select class="filter-select" id="reportType">
                  <option value="monthly">Bulanan</option>
                  <option value="yearly">Tahunan</option>
                </select>
                <select class="filter-select" id="reportMonth">
                  <!-- Months will be loaded dynamically -->
                </select>
                <select class="filter-select" id="reportYear">
                  <!-- Years will be loaded dynamically -->
                </select>
                <button class="btn btn-primary" id="generateReport">
                  <i class="fas fa-chart-bar"></i>
                  Tampilkan Laporan
                </button>
                <button class="btn btn-success" id="exportPdf">
                  <i class="fas fa-file-pdf"></i>
                  Ekspor ke PDF
                </button>
              </div>
            </div>
            <div class="charts-container">
              <div class="chart-card">
                <h3 class="chart-title" id="reportTitle">Laporan Bulanan</h3>
                <div class="chart-container">
                  <canvas id="reportChart"></canvas>
                </div>
              </div>
            </div>
            <div class="table-container">
              <table id="reportTable">
                <thead>
                  <tr>
                    <th>Kategori</th>
                    <th>Jumlah Transaksi</th>
                    <th>Total</th>
                    <th>Persentase</th>
                  </tr>
                </thead>
                <tbody id="reportTableBody">
                  <!-- Report data will be loaded here -->
                </tbody>
              </table>
            </div>
          </section>

          <!-- Settings Page -->
          <section id="settings" class="page">
            <div class="page-header">
              <h2 class="page-title">Pengaturan</h2>
            </div>
            <div class="form-container">
              <h3 style="margin-bottom: 1.5rem">Tema Aplikasi</h3>
              <div class="form-group">
                <div class="radio-group">
                  <div class="radio-option">
                    <input
                      type="radio"
                      id="lightTheme"
                      name="theme"
                      value="light"
                      checked
                    />
                    <label for="lightTheme">Tema Terang</label>
                  </div>
                  <div class="radio-option">
                    <input
                      type="radio"
                      id="darkTheme"
                      name="theme"
                      value="dark"
                    />
                    <label for="darkTheme">Tema Gelap</label>
                  </div>
                </div>
              </div>
              <h3 style="margin-bottom: 1.5rem; margin-top: 2rem">
                Kategori Transaksi
              </h3>
              <div class="form-group">
                <div style="display: flex; gap: 10px">
                  <input
                    type="text"
                    class="form-control"
                    id="newCategory"
                    placeholder="Nama kategori baru"
                  />
                  <select
                    class="form-control"
                    id="categoryType"
                    style="flex: 0 0 150px"
                  >
                    <option value="income">Pemasukan</option>
                    <option value="expense">Pengeluaran</option>
                  </select>
                  <button class="btn btn-primary" id="addCategoryBtn">
                    <i class="fas fa-plus"></i>
                    Tambah
                  </button>
                </div>
              </div>
              <div class="form-group">
                <h4>Kategori Pemasukan</h4>
                <div
                  id="incomeCategoriesList"
                  style="
                    border: 1px solid #ddd;
                    border-radius: var(--border-radius);
                    padding: 10px;
                    max-height: 200px;
                    overflow-y: auto;
                  "
                >
                  <!-- Income categories will be loaded here -->
                </div>
              </div>
              <div class="form-group">
                <h4>Kategori Pengeluaran</h4>
                <div
                  id="expenseCategoriesList"
                  style="
                    border: 1px solid #ddd;
                    border-radius: var(--border-radius);
                    padding: 10px;
                    max-height: 200px;
                    overflow-y: auto;
                  "
                >
                  <!-- Expense categories will be loaded here -->
                </div>
              </div>
              <div class="form-group" style="margin-top: 2rem">
                <button
                  class="btn btn-danger"
                  id="resetDataBtn"
                  style="width: 100%"
                >
                  <i class="fas fa-trash-alt"></i>
                  Reset Semua Data
                </button>
                <p
                  style="
                    margin-top: 0.5rem;
                    font-size: 0.9rem;
                    color: var(--danger-color);
                  "
                >
                  Peringatan: Tindakan ini akan menghapus semua data transaksi,
                  akun, dan pengaturan. Data tidak dapat dikembalikan.
                </p>
              </div>
            </div>
          </section>
        </main>
      </div>

      <!-- Floating Action Button -->
      <button
        class="fab"
        id="fabButton"
        onclick="showModal('addTransactionModal')"
      >
        <i class="fas fa-plus"></i>
      </button>

      <!-- Bottom Navigation for Mobile -->
      <nav class="bottom-nav" id="bottomNav">
        <button class="nav-item active" data-page="dashboard">
          <div class="nav-icon">
            <i class="fas fa-home"></i>
          </div>
          <div class="nav-text">Beranda</div>
        </button>
        <button class="nav-item" data-page="transactions">
          <div class="nav-icon">
            <i class="fas fa-history"></i>
          </div>
          <div class="nav-text">Riwayat</div>
        </button>
        <button class="nav-item" data-page="accounts">
          <div class="nav-icon">
            <i class="fas fa-wallet"></i>
          </div>
          <div class="nav-text">Akun</div>
        </button>
        <button class="nav-item" data-page="reports">
          <div class="nav-icon">
            <i class="fas fa-chart-pie"></i>
          </div>
          <div class="nav-text">Laporan</div>
        </button>
        <button class="nav-item" data-page="settings">
          <div class="nav-icon">
            <i class="fas fa-cog"></i>
          </div>
          <div class="nav-text">Pengaturan</div>
        </button>
      </nav>
    </div>

    <!-- Modal Tambah Transaksi -->
    <div class="modal" id="addTransactionModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Tambah Transaksi Baru</h3>
          <button class="close-modal" id="closeAddTransactionModal">
            &times;
          </button>
        </div>
        <form id="transactionForm">
          <div class="form-group">
            <label>Tipe Transaksi</label>
            <div class="radio-group">
              <div class="radio-option">
                <input
                  type="radio"
                  id="incomeType"
                  name="type"
                  value="income"
                  checked
                />
                <label for="incomeType">Pemasukan</label>
              </div>
              <div class="radio-option">
                <input
                  type="radio"
                  id="expenseType"
                  name="type"
                  value="expense"
                />
                <label for="expenseType">Pengeluaran</label>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label for="category">Kategori</label>
            <select class="form-control" id="category" name="category" required>
              <!-- Categories will be loaded dynamically -->
            </select>
          </div>
          <div class="form-group">
            <label for="description">Deskripsi</label>
            <input
              type="text"
              class="form-control"
              id="description"
              name="description"
              placeholder="Masukkan deskripsi transaksi"
              required
            />
          </div>
          <div class="form-group">
            <label for="amount">Jumlah (Rp)</label>
            <input
              type="number"
              class="form-control"
              id="amount"
              name="amount"
              min="1"
              placeholder="0"
              required
            />
          </div>
          <div class="form-group">
            <label for="date">Tanggal</label>
            <input
              type="date"
              class="form-control"
              id="date"
              name="date"
              required
            />
          </div>
          <div class="modal-actions">
            <button
              type="button"
              class="btn"
              id="cancelAddTransaction"
              style="background-color: #ddd; color: var(--dark-color)"
            >
              Batal
            </button>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i>
              Simpan Transaksi
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Tambah Akun -->
    <div class="modal" id="addAccountModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Tambah Akun Baru</h3>
          <button class="close-modal" id="closeAddAccountModal">&times;</button>
        </div>
        <form id="addAccountForm">
          <div class="form-group">
            <label for="accountName">Nama Akun</label>
            <input
              type="text"
              class="form-control"
              id="accountName"
              name="accountName"
              placeholder="Contoh: Tabungan, Dompet, Kartu Kredit"
              required
            />
          </div>
          <div class="form-group">
            <label for="accountType">Tipe Akun</label>
            <select
              class="form-control"
              id="accountType"
              name="accountType"
              required
            >
              <option value="cash">Tunai (Cash)</option>
              <option value="savings">Tabungan</option>
              <option value="debit">Kartu Debit</option>
              <option value="credit">Kartu Kredit</option>
              <option value="investment">Investasi</option>
              <option value="other">Lainnya</option>
            </select>
          </div>
          <div class="form-group">
            <label for="initialBalance">Saldo Awal (Rp)</label>
            <input
              type="number"
              class="form-control"
              id="initialBalance"
              name="initialBalance"
              placeholder="0"
              min="0"
              value="0"
              required
            />
            <small style="color: var(--gray-color); font-size: 0.8rem"
              >Isi dengan saldo awal akun ini</small
            >
          </div>
          <div class="form-group">
            <label>Warna Akun</label>
            <div class="color-picker" id="colorPicker">
              <!-- Color options will be generated dynamically -->
            </div>
            <input type="hidden" id="selectedColor" value="#4361ee" />
          </div>
          <div class="modal-actions">
            <button
              type="button"
              class="btn"
              id="cancelAddAccount"
              style="background-color: #ddd; color: var(--dark-color)"
            >
              Batal
            </button>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i>
              Simpan Akun
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="modal" id="editTransactionModal">
  <form id="editTransactionForm">
    <input type="hidden" id="editTransactionId">
    <!-- input description, amount, date, type, category -->
  </form>
</div>


    <!-- Modal Edit Akun -->
    <div class="modal" id="editAccountModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Edit Akun</h3>
          <button class="close-modal" id="closeEditAccountModal">
            &times;
          </button>
        </div>
        <form id="editAccountForm">
          <input type="hidden" id="editAccountId" />
          <div class="form-group">
            <label for="editAccountName">Nama Akun</label>
            <input
              type="text"
              class="form-control"
              id="editAccountName"
              name="editAccountName"
              required
            />
          </div>
          <div class="form-group">
            <label for="editAccountType">Tipe Akun</label>
            <select
              class="form-control"
              id="editAccountType"
              name="editAccountType"
              required
            >
              <option value="cash">Tunai (Cash)</option>
              <option value="savings">Tabungan</option>
              <option value="debit">Kartu Debit</option>
              <option value="credit">Kartu Kredit</option>
              <option value="investment">Investasi</option>
              <option value="other">Lainnya</option>
            </select>
          </div>
          <div class="form-group">
            <label>Warna Akun</label>
            <div class="color-picker" id="editColorPicker">
              <!-- Color options will be generated dynamically -->
            </div>
            <input type="hidden" id="editSelectedColor" />
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-danger" id="deleteAccountBtn">
              <i class="fas fa-trash"></i>
              Hapus Akun
            </button>
            <button
              type="button"
              class="btn"
              id="cancelEditAccount"
              style="background-color: #ddd; color: var(--dark-color)"
            >
              Batal
            </button>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i>
              Simpan Perubahan
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- JavaScript -->
    <script>
      // Initialize data and state
      let currentAccount = "default";
      let transactions = [];
      let accounts = [];
      let categories = {
        income: ["Gaji", "Bonus", "Investasi", "Hadiah", "Lainnya"],
        expense: [
          "Makanan",
          "Transportasi",
          "Belanja",
          "Hiburan",
          "Kesehatan",
          "Pendidikan",
          "Lainnya",
        ],
      };
      let theme = "light";

      // DOM Elements
      let barChart = null;
      let pieChart = null;
      let reportChart = null;

      // Predefined color options for accounts
      const accountColors = [
        "#4361ee",
        "#3a56d4",
        "#3f37c9",
        "#4cc9f0",
        "#4895ef",
        "#7209b7",
        "#560bad",
        "#480ca8",
        "#3a0ca3",
        "#f72585",
        "#b5179e",
        "#7209b7",
        "#560bad",
        "#480ca8",
        "#3a0ca3",
        "#4cc9f0",
        "#4895ef",
        "#4361ee",
        "#3a56d4",
        "#3f37c9",
        "#38b000",
        "#70e000",
        "#9ef01a",
        "#ccff33",
        "#ff5400",
        "#ff6d00",
        "#ff8500",
        "#ff9100",
        "#ff9e00",
        "#ffaa00",
      ];

      // Initialize the application
      document.addEventListener("DOMContentLoaded", function () {
        console.log("Initializing FinTrack App...");

        // Load data from localStorage
        loadDataFromStorage();

        // Initialize event listeners
        initEventListeners();
        initModals();

        // Initialize UI
        updateDashboard();
        updateTransactionsTable();
        updateAccountSelector();
        updateAccountsDisplay();
        updateCategoriesDropdown();
        updateCategoriesDisplay();
        updateDateFilters();
        updateTheme();

        // Set current date
        const today = new Date();
        document.getElementById("monthFilter").value =
          today.getFullYear() +
          "-" +
          String(today.getMonth() + 1).padStart(2, "0");
        document.getElementById("date").valueAsDate = today;

        // Show current month
        const monthNames = [
          "Januari",
          "Februari",
          "Maret",
          "April",
          "Mei",
          "Juni",
          "Juli",
          "Agustus",
          "September",
          "Oktober",
          "November",
          "Desember",
        ];
        const currentMonth =
          monthNames[today.getMonth()] + " " + today.getFullYear();
        document.getElementById("currentMonth").textContent = currentMonth;

        // Check screen width and show appropriate navigation
        handleResponsiveNavigation();

        // Add event listener for window resize
        window.addEventListener("resize", handleResponsiveNavigation);

        console.log("FinTrack App initialized successfully!");
      });

      // Handle responsive navigation
      function handleResponsiveNavigation() {
        const isMobile = window.innerWidth <= 768;
        const desktopSidebar = document.getElementById("desktopSidebar");
        const bottomNav = document.getElementById("bottomNav");

        if (isMobile) {
          // Mobile: Hide desktop sidebar, show bottom nav
          if (desktopSidebar) desktopSidebar.style.display = "none";
          if (bottomNav) bottomNav.style.display = "flex";
        } else {
          // Desktop: Show desktop sidebar, hide bottom nav
          if (desktopSidebar) desktopSidebar.style.display = "flex";
          if (bottomNav) bottomNav.style.display = "none";
        }
      }

      // Initialize modals
      function initModals() {
        console.log("Initializing modals...");

        // Generate color options
        generateColorOptions();

        // Add transaction modal
        const addTransactionModal = document.getElementById(
          "addTransactionModal"
        );
        const closeAddTransactionModal = document.getElementById(
          "closeAddTransactionModal"
        );
        const cancelAddTransaction = document.getElementById(
          "cancelAddTransaction"
        );
        const transactionForm = document.getElementById("transactionForm");

        closeAddTransactionModal.addEventListener("click", () => {
          hideModal("addTransactionModal");
        });

        cancelAddTransaction.addEventListener("click", () => {
          hideModal("addTransactionModal");
        });

        transactionForm.addEventListener("submit", (e) => {
          e.preventDefault();
          addTransaction();
        });

        // Add account modal
        const addAccountModal = document.getElementById("addAccountModal");
        const addAccountBtn = document.getElementById("addAccountBtn");
        const closeAddAccountModal = document.getElementById(
          "closeAddAccountModal"
        );
        const cancelAddAccount = document.getElementById("cancelAddAccount");
        const addAccountForm = document.getElementById("addAccountForm");

        addAccountBtn.addEventListener("click", () => {
          showModal("addAccountModal");
        });

        closeAddAccountModal.addEventListener("click", () => {
          hideModal("addAccountModal");
        });

        cancelAddAccount.addEventListener("click", () => {
          hideModal("addAccountModal");
        });

        addAccountForm.addEventListener("submit", (e) => {
          e.preventDefault();
          submitAddAccountForm();
        });

        // Edit account modal
        const editAccountModal = document.getElementById("editAccountModal");
        const closeEditAccountModal = document.getElementById(
          "closeEditAccountModal"
        );
        const cancelEditAccount = document.getElementById("cancelEditAccount");
        const editAccountForm = document.getElementById("editAccountForm");
        const deleteAccountBtn = document.getElementById("deleteAccountBtn");

        closeEditAccountModal.addEventListener("click", () => {
          hideModal("editAccountModal");
        });

        cancelEditAccount.addEventListener("click", () => {
          hideModal("editAccountModal");
        });

        editAccountForm.addEventListener("submit", (e) => {
          e.preventDefault();
          submitEditAccountForm();
        });

        deleteAccountBtn.addEventListener("click", () => {
          const accountId = document.getElementById("editAccountId").value;
          if (accountId) {
            deleteAccount(accountId);
            hideModal("editAccountModal");
          }
        });

        // Close modal when clicking outside
        window.addEventListener("click", (e) => {
          if (e.target.classList.contains("modal")) {
            hideModal(e.target.id);
          }
        });

        console.log("Modals initialized");
      }

      // Generate color options for color picker
      function generateColorOptions() {
        const colorPicker = document.getElementById("colorPicker");
        const editColorPicker = document.getElementById("editColorPicker");

        colorPicker.innerHTML = "";
        editColorPicker.innerHTML = "";

        accountColors.forEach((color) => {
          // For add modal
          const colorOption = document.createElement("div");
          colorOption.className = "color-option";
          colorOption.style.backgroundColor = color;
          colorOption.dataset.color = color;
          colorOption.addEventListener("click", () => {
            document
              .querySelectorAll("#colorPicker .color-option")
              .forEach((opt) => {
                opt.classList.remove("selected");
              });
            colorOption.classList.add("selected");
            document.getElementById("selectedColor").value = color;
          });

          // Select first color by default
          if (color === "#4361ee") {
            colorOption.classList.add("selected");
          }

          colorPicker.appendChild(colorOption);

          // For edit modal
          const editColorOption = document.createElement("div");
          editColorOption.className = "color-option";
          editColorOption.style.backgroundColor = color;
          editColorOption.dataset.color = color;
          editColorOption.addEventListener("click", () => {
            document
              .querySelectorAll("#editColorPicker .color-option")
              .forEach((opt) => {
                opt.classList.remove("selected");
              });
            editColorOption.classList.add("selected");
            document.getElementById("editSelectedColor").value = color;
          });

          editColorPicker.appendChild(editColorOption);
        });
      }

      // Show modal
      function showModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.style.display = "flex";
          document.body.style.overflow = "hidden";

          // Reset form if it's add account modal
          if (modalId === "addAccountModal") {
            document.getElementById("accountName").focus();
          }

          // Reset form if it's add transaction modal
          if (modalId === "addTransactionModal") {
            document.getElementById("transactionForm").reset();
            document.getElementById("date").valueAsDate = new Date();
            document.querySelector(
              'input[name="type"][value="income"]'
            ).checked = true;
            updateCategoriesDropdown();
            document.getElementById("description").focus();
          }
        }
      }

      // Hide modal
      function hideModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.style.display = "none";
          document.body.style.overflow = "auto";

          // Reset form
          if (modalId === "addAccountModal") {
            document.getElementById("addAccountForm").reset();
            document.getElementById("initialBalance").value = "0";
            // Reset to default color
            document.getElementById("selectedColor").value = "#4361ee";
            document
              .querySelectorAll("#colorPicker .color-option")
              .forEach((opt) => {
                opt.classList.remove("selected");
                if (opt.dataset.color === "#4361ee") {
                  opt.classList.add("selected");
                }
              });
          }
        }
      }

      // Load data from localStorage
      function loadDataFromStorage() {
        try {
          // Load transactions
          const savedTransactions = localStorage.getItem(
            "finTrackTransactions"
          );
          if (savedTransactions) {
            transactions = JSON.parse(savedTransactions);
          }

          // Load accounts
          const savedAccounts = localStorage.getItem("finTrackAccounts");
          if (savedAccounts) {
            accounts = JSON.parse(savedAccounts);
          } else {
            // Create default account if none exist
            accounts = [
              {
                id: "default",
                name: "Akun Utama",
                type: "cash",
                typeLabel: "Tunai",
                balance: 0,
                color: "#4361ee",
                created: new Date().toISOString(),
                lastUpdated: new Date().toISOString(),
                transactionCount: 0,
              },
            ];
            saveAccountsToStorage();
          }

          // Load categories
          const savedCategories = localStorage.getItem("finTrackCategories");
          if (savedCategories) {
            categories = JSON.parse(savedCategories);
          }

          // Load theme
          const savedTheme = localStorage.getItem("finTrackTheme");
          if (savedTheme) {
            theme = savedTheme;
          }

          // Load current account
          const savedCurrentAccount = localStorage.getItem(
            "finTrackCurrentAccount"
          );
          if (savedCurrentAccount) {
            currentAccount = savedCurrentAccount;
          }
        } catch (error) {
          console.error("Error loading data:", error);
        }
      }

      // Save data to localStorage
      function saveTransactionsToStorage() {
        localStorage.setItem(
          "finTrackTransactions",
          JSON.stringify(transactions)
        );
      }

      function saveAccountsToStorage() {
        localStorage.setItem("finTrackAccounts", JSON.stringify(accounts));
      }

      function saveCategoriesToStorage() {
        localStorage.setItem("finTrackCategories", JSON.stringify(categories));
      }

      function saveThemeToStorage() {
        localStorage.setItem("finTrackTheme", theme);
      }

      function saveCurrentAccountToStorage() {
        localStorage.setItem("finTrackCurrentAccount", currentAccount);
      }

      // Initialize event listeners
      function initEventListeners() {
        console.log("Setting up event listeners...");

        // Bottom navigation
        const bottomNavItems = document.querySelectorAll(
          ".bottom-nav .nav-item"
        );
        bottomNavItems.forEach((item) => {
          item.addEventListener("click", function () {
            const pageId = this.getAttribute("data-page");
            showPage(pageId);

            // Update active nav item
            bottomNavItems.forEach((item) => item.classList.remove("active"));
            this.classList.add("active");

            // Update desktop navigation if visible
            updateDesktopNavigation(pageId);
          });
        });

        // Desktop navigation
        const desktopNavItems = document.querySelectorAll(
          ".sidebar .nav-item-desktop"
        );
        desktopNavItems.forEach((item) => {
          item.addEventListener("click", function () {
            const pageId = this.getAttribute("data-page");
            showPage(pageId);

            // Update active nav item
            desktopNavItems.forEach((item) => item.classList.remove("active"));
            this.classList.add("active");

            // Update bottom navigation if visible
            updateBottomNavigation(pageId);
          });
        });

        // Account selector
        document
          .getElementById("accountSelector")
          .addEventListener("change", function () {
            currentAccount = this.value;
            saveCurrentAccountToStorage();
            updateDashboard();
            updateTransactionsTable();
            updateAccountsDisplay();
            updateCategoryFilter();
          });

        // Theme toggle
        document
          .getElementById("themeToggle")
          .addEventListener("click", toggleTheme);

        // Theme radio buttons
        document.querySelectorAll('input[name="theme"]').forEach((radio) => {
          radio.addEventListener("change", function () {
            theme = this.value;
            saveThemeToStorage();
            updateTheme();
          });
        });

        // Transaction type radio buttons
        document.querySelectorAll('input[name="type"]').forEach((radio) => {
          radio.addEventListener("change", function () {
            updateCategoriesDropdown();
          });
        });

        // Filter button
        document
          .getElementById("filterButton")
          .addEventListener("click", function () {
            updateTransactionsTable();
          });

        // Add category button
        document
          .getElementById("addCategoryBtn")
          .addEventListener("click", addNewCategory);

        // Generate report button
        document
          .getElementById("generateReport")
          .addEventListener("click", generateReport);

        // Export PDF button
        document
          .getElementById("exportPdf")
          .addEventListener("click", exportToPDF);

        // Reset data button
        document
          .getElementById("resetDataBtn")
          .addEventListener("click", resetAllData);

        // View all transactions button
        document
          .getElementById("viewAllTransactions")
          .addEventListener("click", function () {
            showPage("transactions");
            updateBottomNavigation("transactions");
            updateDesktopNavigation("transactions");
          });

        // Report type change
        document
          .getElementById("reportType")
          .addEventListener("change", function () {
            const isMonthly = this.value === "monthly";
            document.getElementById("reportMonth").style.display = isMonthly
              ? "block"
              : "none";
            generateReport();
          });

        console.log("Event listeners setup complete");
      }

      // Update desktop navigation
      function updateDesktopNavigation(pageId) {
        const desktopNavItems = document.querySelectorAll(
          ".sidebar .nav-item-desktop"
        );
        desktopNavItems.forEach((item) => {
          item.classList.remove("active");
          if (item.getAttribute("data-page") === pageId) {
            item.classList.add("active");
          }
        });
      }

      // Update bottom navigation
      function updateBottomNavigation(pageId) {
        const bottomNavItems = document.querySelectorAll(
          ".bottom-nav .nav-item"
        );
        bottomNavItems.forEach((item) => {
          item.classList.remove("active");
          if (item.getAttribute("data-page") === pageId) {
            item.classList.add("active");
          }
        });
      }

      // Show page by ID
      function showPage(pageId) {
        console.log("Showing page:", pageId);

        // Hide all pages
        const pages = document.querySelectorAll(".page");
        pages.forEach((page) => {
          page.classList.remove("active");
        });

        // Show selected page
        const selectedPage = document.getElementById(pageId);
        if (selectedPage) {
          selectedPage.classList.add("active");

          // Scroll to top
          window.scrollTo(0, 0);

          // Update specific page content if needed
          if (pageId === "dashboard") {
            updateDashboard();
          } else if (pageId === "transactions") {
            updateTransactionsTable();
            updateCategoryFilter();
          } else if (pageId === "reports") {
            updateDateFilters();
            generateReport();
          } else if (pageId === "accounts") {
            updateAccountsDisplay();
          }
        }
      }

      // Toggle theme
      function toggleTheme() {
        theme = theme === "light" ? "dark" : "light";
        saveThemeToStorage();
        updateTheme();

        // Update radio buttons
        document.querySelectorAll('input[name="theme"]').forEach((radio) => {
          if (radio.value === theme) {
            radio.checked = true;
          }
        });
      }

      // Update theme
      function updateTheme() {
        if (theme === "dark") {
          document.body.classList.add("dark-theme");
          document.getElementById("themeToggle").innerHTML =
            '<i class="fas fa-sun"></i>';
        } else {
          document.body.classList.remove("dark-theme");
          document.getElementById("themeToggle").innerHTML =
            '<i class="fas fa-moon"></i>';
        }
      }

      // Update categories dropdown
      function updateCategoriesDropdown() {
        const type = document.querySelector('input[name="type"]:checked').value;
        const categorySelect = document.getElementById("category");

        // Clear existing options
        categorySelect.innerHTML = "";

        // Add options based on type
        categories[type].forEach((category) => {
          const option = document.createElement("option");
          option.value = category;
          option.textContent = category;
          categorySelect.appendChild(option);
        });
      }

      // Add a new transaction
      function addTransaction() {
        try {
          const type = document.querySelector(
            'input[name="type"]:checked'
          ).value;
          const category = document.getElementById("category").value;
          const description = document
            .getElementById("description")
            .value.trim();
          const amount = parseInt(document.getElementById("amount").value);
          const date = document.getElementById("date").value;

          // Validate
          if (!description || !amount || amount <= 0) {
            alert("Harap isi semua field dengan benar!");
            return;
          }

          // Create transaction object
          const transaction = {
            id: Date.now().toString(),
            account: currentAccount,
            type: type,
            category: category,
            description: description,
            amount: amount,
            date: date,
            timestamp: new Date().toISOString(),
          };

          // Add to transactions array
          transactions.push(transaction);

          // Update account balance
          const accountIndex = accounts.findIndex(
            (acc) => acc.id === currentAccount
          );
          if (accountIndex !== -1) {
            if (type === "income") {
              accounts[accountIndex].balance += amount;
            } else {
              accounts[accountIndex].balance -= amount;
            }
            accounts[accountIndex].lastUpdated = new Date().toISOString();
            saveAccountsToStorage();
          }

          // Save to storage
          saveTransactionsToStorage();

          // Reset form and hide modal
          hideModal("addTransactionModal");

          // Update UI
          updateDashboard();
          updateTransactionsTable();
          updateAccountsDisplay();
          updateAccountSelector();
          updateCategoryFilter();

          // Show success message
          alert("Transaksi berhasil ditambahkan!");
        } catch (error) {
          console.error("Error adding transaction:", error);
          alert("Terjadi kesalahan saat menambahkan transaksi");
        }
      }

      // Delete a transaction
      function deleteTransaction(id) {
        if (!confirm("Apakah Anda yakin ingin menghapus transaksi ini?")) {
          return;
        }

        try {
          // Find transaction
          const transactionIndex = transactions.findIndex((t) => t.id === id);
          if (transactionIndex === -1) return;

          const transaction = transactions[transactionIndex];

          // Update account balance
          const accountIndex = accounts.findIndex(
            (acc) => acc.id === transaction.account
          );
          if (accountIndex !== -1) {
            if (transaction.type === "income") {
              accounts[accountIndex].balance -= transaction.amount;
            } else {
              accounts[accountIndex].balance += transaction.amount;
            }
            accounts[accountIndex].lastUpdated = new Date().toISOString();
            saveAccountsToStorage();
          }

          // Remove transaction
          transactions.splice(transactionIndex, 1);
          saveTransactionsToStorage();

          // Update UI
          updateDashboard();
          updateTransactionsTable();
          updateAccountsDisplay();
          updateAccountSelector();
          updateCategoryFilter();

          alert("Transaksi berhasil dihapus!");
        } catch (error) {
          console.error("Error deleting transaction:", error);
          alert("Terjadi kesalahan saat menghapus transaksi");
        }
      }

      // Update dashboard
      function updateDashboard() {
        try {
          // Filter transactions for current account and current month
          const now = new Date();
          const currentMonth = now.getMonth();
          const currentYear = now.getFullYear();

          const accountTransactions = transactions.filter(
            (t) =>
              t.account === currentAccount &&
              new Date(t.date).getMonth() === currentMonth &&
              new Date(t.date).getFullYear() === currentYear
          );

          // Calculate totals
          let totalIncome = 0;
          let totalExpense = 0;

          accountTransactions.forEach((transaction) => {
            if (transaction.type === "income") {
              totalIncome += transaction.amount;
            } else {
              totalExpense += transaction.amount;
            }
          });

          const totalBalance = totalIncome - totalExpense;

          // Update UI
          document.getElementById("totalBalance").textContent =
            formatCurrency(totalBalance);
          document.getElementById("totalIncome").textContent =
            formatCurrency(totalIncome);
          document.getElementById("totalExpense").textContent =
            formatCurrency(totalExpense);

          // Update recent transactions
          updateRecentTransactions();

          // Update charts
          updateCharts();
        } catch (error) {
          console.error("Error updating dashboard:", error);
        }
      }

      // Update recent transactions
      function updateRecentTransactions() {
        const container = document.getElementById("recentTransactions");

        try {
          // Filter transactions for current account, sort by date (newest first)
          const accountTransactions = transactions
            .filter((t) => t.account === currentAccount)
            .sort((a, b) => new Date(b.date) - new Date(a.date))
            .slice(0, 5);

          if (accountTransactions.length === 0) {
            container.innerHTML =
              '<tr><td colspan="5" style="text-align: center;">Belum ada transaksi</td></tr>';
            return;
          }

          let html = "";
          accountTransactions.forEach((transaction) => {
            html += `
                    <tr>
                        <td>${formatDate(transaction.date)}</td>
                        <td>${transaction.category}</td>
                        <td>${transaction.description}</td>
                        <td>${formatCurrency(transaction.amount)}</td>
                        <td><span class="transaction-type type-${
                          transaction.type
                        }">${
              transaction.type === "income" ? "Pemasukan" : "Pengeluaran"
            }</span></td>
                    </tr>
                `;
          });

          container.innerHTML = html;
        } catch (error) {
          console.error("Error updating recent transactions:", error);
          container.innerHTML =
            '<tr><td colspan="5" style="text-align: center; color: red;">Error loading transactions</td></tr>';
        }
      }

      // Update transactions table
      function updateTransactionsTable() {
        const container = document.getElementById("transactionsTable");

        try {
          const typeFilter =
            document.getElementById("transactionTypeFilter")?.value || "all";
          const categoryFilter =
            document.getElementById("categoryFilter")?.value || "all";
          const monthFilter =
            document.getElementById("monthFilter")?.value || "";

          // Filter by account
          let filteredTransactions = transactions.filter(
            (t) => t.account === currentAccount
          );

          // Filter by type
          if (typeFilter !== "all") {
            filteredTransactions = filteredTransactions.filter(
              (t) => t.type === typeFilter
            );
          }

          // Filter by category
          if (categoryFilter !== "all") {
            filteredTransactions = filteredTransactions.filter(
              (t) => t.category === categoryFilter
            );
          }

          // Filter by month
          if (monthFilter) {
            const [year, month] = monthFilter.split("-");
            filteredTransactions = filteredTransactions.filter((t) => {
              const transDate = new Date(t.date);
              return (
                transDate.getFullYear() === parseInt(year) &&
                transDate.getMonth() + 1 === parseInt(month)
              );
            });
          }

          // Sort newest first
          filteredTransactions.sort(
            (a, b) => new Date(b.date) - new Date(a.date)
          );

          // Empty state
          if (filteredTransactions.length === 0) {
            container.innerHTML = `
              <tr>
                <td colspan="6" style="text-align:center;">
                  Tidak ada transaksi
                </td>
              </tr>
            `;
            return;
          }

          // Render table
          let html = "";
          filteredTransactions.forEach((transaction) => {
            html += `
              <tr>
                <td>${formatDate(transaction.date)}</td>
                <td>${transaction.category}</td>
                <td>${transaction.description}</td>
                <td>${formatCurrency(transaction.amount)}</td>
                <td>
                  <span class="transaction-type type-${transaction.type}">
                    ${
                      transaction.type === "income"
                        ? "Pemasukan"
                        : "Pengeluaran"
                    }
                  </span>
                </td>
                <td>
                  <div class="action-buttons">
                    <button
                      class="btn-icon"
                      title="Edit"
                      onclick="openEditTransaction('${transaction.id}')"
                    >
                      <i class="fas fa-edit"></i>
                    </button>

                    <button
                      class="btn-icon"
                      title="Hapus"
                      onclick="deleteTransaction('${transaction.id}')"
                    >
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
            `;
          });

          container.innerHTML = html;
        } catch (error) {
          console.error("Error updating transactions table:", error);
          container.innerHTML = `
            <tr>
              <td colspan="6" style="text-align:center;color:red;">
                Terjadi kesalahan menampilkan data
              </td>
            </tr>
          `;
        }
      }
          // Sort by date (newest first)
          filteredTransactions.sort(
            (a, b) => new Date(b.date) - new Date(a.date)
          );

          if (filteredTransactions.length === 0) {
            container.innerHTML =
              '<tr><td colspan="6" style="text-align: center;">Tidak ada transaksi</td></tr>';
            return;
          }

          let html = "";
          filteredTransactions.forEach((transaction) => {
            html += `
                    <tr>
                        <td>${formatDate(transaction.date)}</td>
                        <td>${transaction.category}</td>
                        <td>${transaction.description}</td>
                        <td>${formatCurrency(transaction.amount)}</td>
                        <td><span class="transaction-type type-${
                          transaction.type
                        }">${
              transaction.type === "income" ? "Pemasukan" : "Pengeluaran"
            }</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-icon" onclick="deleteTransaction('${
                                  transaction.id
                                }')" title="Hapus">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
          });

          container.innerHTML = html;
        } catch (error) {
          console.error("Error updating transactions table:", error);
          container.innerHTML =
            '<tr><td colspan="6" style="text-align: center; color: red;">Error loading transactions</td></tr>';
        }
      }

      // Update category filter
      function updateCategoryFilter() {
        const categoryFilter = document.getElementById("categoryFilter");

        try {
          // Get all unique categories from transactions
          const allCategories = [
            ...new Set(
              transactions
                .filter((t) => t.account === currentAccount)
                .map((t) => t.category)
            ),
          ];

          // Save current value
          const currentValue = categoryFilter.value;

          // Clear and add options
          categoryFilter.innerHTML =
            '<option value="all">Semua Kategori</option>';

          allCategories.forEach((category) => {
            const option = document.createElement("option");
            option.value = category;
            option.textContent = category;
            categoryFilter.appendChild(option);
          });

          // Restore previous value if it still exists
          if (allCategories.includes(currentValue)) {
            categoryFilter.value = currentValue;
          }
        } catch (error) {
          console.error("Error updating category filter:", error);
        }
      }

      // Update charts
      function updateCharts() {
        try {
          // Filter transactions for current account and current month
          const now = new Date();
          const currentMonth = now.getMonth();
          const currentYear = now.getFullYear();

          const accountTransactions = transactions.filter(
            (t) =>
              t.account === currentAccount &&
              new Date(t.date).getMonth() === currentMonth &&
              new Date(t.date).getFullYear() === currentYear
          );

          // Prepare data for bar chart (income vs expense by week)
          const weeks = {};
          accountTransactions.forEach((transaction) => {
            const date = new Date(transaction.date);
            const week = Math.ceil(date.getDate() / 7);

            if (!weeks[week]) {
              weeks[week] = { income: 0, expense: 0 };
            }

            if (transaction.type === "income") {
              weeks[week].income += transaction.amount;
            } else {
              weeks[week].expense += transaction.amount;
            }
          });

          const weekLabels = Object.keys(weeks).sort((a, b) => a - b);
          const incomeData = weekLabels.map((week) => weeks[week].income);
          const expenseData = weekLabels.map((week) => weeks[week].expense);

          // Bar chart
          const barCtx = document.getElementById("barChart").getContext("2d");
          if (barChart) {
            barChart.destroy();
          }

          barChart = new Chart(barCtx, {
            type: "bar",
            data: {
              labels: weekLabels.map((week) => `Minggu ${week}`),
              datasets: [
                {
                  label: "Pemasukan",
                  data: incomeData,
                  backgroundColor: "rgba(76, 201, 240, 0.7)",
                  borderColor: "rgba(76, 201, 240, 1)",
                  borderWidth: 1,
                },
                {
                  label: "Pengeluaran",
                  data: expenseData,
                  backgroundColor: "rgba(247, 37, 133, 0.7)",
                  borderColor: "rgba(247, 37, 133, 1)",
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function (value) {
                      return "Rp " + value.toLocaleString("id-ID");
                    },
                  },
                },
              },
              plugins: {
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      return (
                        context.dataset.label +
                        ": Rp " +
                        context.parsed.y.toLocaleString("id-ID")
                      );
                    },
                  },
                },
              },
            },
          });

          // Prepare data for pie chart (expenses by category)
          const expenseCategories = {};
          accountTransactions
            .filter((t) => t.type === "expense")
            .forEach((transaction) => {
              if (!expenseCategories[transaction.category]) {
                expenseCategories[transaction.category] = 0;
              }
              expenseCategories[transaction.category] += transaction.amount;
            });

          const categoryLabels = Object.keys(expenseCategories);
          const categoryData = Object.values(expenseCategories);
          const categoryColors = generateColors(categoryLabels.length);

          // Pie chart
          const pieCtx = document.getElementById("pieChart").getContext("2d");
          if (pieChart) {
            pieChart.destroy();
          }

          if (categoryLabels.length === 0) {
            pieCtx.clearRect(0, 0, pieCtx.canvas.width, pieCtx.canvas.height);
            pieCtx.font = "16px Poppins";
            pieCtx.fillStyle = theme === "dark" ? "#f8f9fa" : "#212529";
            pieCtx.textAlign = "center";
            pieCtx.fillText(
              "Tidak ada data pengeluaran",
              pieCtx.canvas.width / 2,
              pieCtx.canvas.height / 2
            );
            return;
          }

          pieChart = new Chart(pieCtx, {
            type: "pie",
            data: {
              labels: categoryLabels,
              datasets: [
                {
                  data: categoryData,
                  backgroundColor: categoryColors,
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: "bottom",
                },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      const label = context.label || "";
                      const value = context.parsed || 0;
                      const total = context.dataset.data.reduce(
                        (a, b) => a + b,
                        0
                      );
                      const percentage = Math.round((value / total) * 100);
                      return `${label}: Rp ${value.toLocaleString(
                        "id-ID"
                      )} (${percentage}%)`;
                    },
                  },
                },
              },
            },
          });
        } catch (error) {
          console.error("Error updating charts:", error);
        }
      }

      // Update account selector
      function updateAccountSelector() {
        const selector = document.getElementById("accountSelector");

        try {
          // Save current value
          const currentValue = selector.value;

          // Clear and add options
          selector.innerHTML = "";

          accounts.forEach((account) => {
            const option = document.createElement("option");
            option.value = account.id;
            option.textContent = account.name;
            selector.appendChild(option);
          });

          // Restore current value
          if (accounts.some((acc) => acc.id === currentValue)) {
            selector.value = currentValue;
            currentAccount = currentValue;
          } else {
            currentAccount = accounts[0].id;
            selector.value = currentAccount;
          }

          saveCurrentAccountToStorage();
        } catch (error) {
          console.error("Error updating account selector:", error);
        }
      }

      // Update accounts display
      function updateAccountsDisplay() {
        const container = document.getElementById("accountsContainer");

        try {
          if (accounts.length === 0) {
            container.innerHTML =
              '<p style="text-align: center; grid-column: 1 / -1;">Belum ada akun yang dibuat</p>';
            return;
          }

          let html = "";
          accounts.forEach((account) => {
            // Calculate account balance from transactions
            let balance = 0;
            const accountTransactions = transactions.filter(
              (t) => t.account === account.id
            );
            accountTransactions.forEach((transaction) => {
              if (transaction.type === "income") {
                balance += transaction.amount;
              } else {
                balance -= transaction.amount;
              }
            });

            // Add initial balance if it exists
            if (account.initialBalance && accountTransactions.length === 0) {
              balance = account.initialBalance;
            }

            // Update account balance
            account.balance = balance;
            account.transactionCount = accountTransactions.length;

            const isActive = account.id === currentAccount;
            const typeLabels = {
              cash: "Tunai",
              savings: "Tabungan",
              debit: "Kartu Debit",
              credit: "Kartu Kredit",
              investment: "Investasi",
              other: "Lainnya",
            };

            const typeLabel = typeLabels[account.type] || "Akun";

            html += `
                    <div class="account-card ${
                      isActive ? "active" : ""
                    }" style="border-color: ${account.color}">
                        <div class="account-card-header">
                            <div>
                                <div class="account-name">${account.name}</div>
                                <small style="color: var(--gray-color); font-size: 0.8rem;">
                                    <i class="fas fa-${getAccountIcon(
                                      account.type
                                    )}"></i> ${typeLabel}
                                </small>
                            </div>
                            <div class="action-buttons">
                                <button class="btn-icon" onclick="showEditAccountModal('${
                                  account.id
                                }')" title="Edit Akun">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-icon" onclick="deleteAccount('${
                                  account.id
                                }')"
                                        ${
                                          account.id === "default"
                                            ? "disabled"
                                            : ""
                                        }
                                        title="${
                                          account.id === "default"
                                            ? "Akun default tidak dapat dihapus"
                                            : "Hapus Akun"
                                        }">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="account-balance" style="color: ${
                          account.color
                        }">
                            ${formatCurrency(balance)}
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.9rem; color: var(--gray-color); margin-top: 10px;">
                            <span><i class="fas fa-exchange-alt"></i> ${
                              accountTransactions.length
                            } transaksi</span>
                            <span>${formatDate(account.created)}</span>
                        </div>
                        <button class="btn ${isActive ? "btn-primary" : ""}"
                                onclick="switchAccount('${account.id}')"
                                style="${
                                  isActive
                                    ? ""
                                    : "background-color: " + account.color + ";"
                                } margin-top: 10px; width: 100%;">
                            ${
                              isActive
                                ? '<i class="fas fa-check"></i> Aktif'
                                : "Pilih Akun"
                            }
                        </button>
                    </div>
                `;
          });

          container.innerHTML = html;
          saveAccountsToStorage();
        } catch (error) {
          console.error("Error updating accounts display:", error);
          container.innerHTML =
            '<p style="text-align: center; grid-column: 1 / -1; color: red;">Error loading accounts</p>';
        }
      }

      // Get account icon based on type
      function getAccountIcon(type) {
        const icons = {
          cash: "money-bill-wave",
          savings: "piggy-bank",
          debit: "credit-card",
          credit: "credit-card",
          investment: "chart-line",
          other: "wallet",
        };
        return icons[type] || "wallet";
      }

      // Submit add account form
      function submitAddAccountForm() {
        try {
          const accountName = document
            .getElementById("accountName")
            .value.trim();
          const accountType = document.getElementById("accountType").value;
          const initialBalance =
            parseInt(document.getElementById("initialBalance").value) || 0;
          const accountColor = document.getElementById("selectedColor").value;

          // Validate
          if (!accountName) {
            alert("Nama akun tidak boleh kosong!");
            return;
          }

          // Check if account name already exists
          if (
            accounts.some(
              (acc) => acc.name.toLowerCase() === accountName.toLowerCase()
            )
          ) {
            alert(`Akun dengan nama "${accountName}" sudah ada!`);
            return;
          }

          // Get type label
          const typeLabels = {
            cash: "Tunai",
            savings: "Tabungan",
            debit: "Kartu Debit",
            credit: "Kartu Kredit",
            investment: "Investasi",
            other: "Lainnya",
          };

          // Create new account
          const newAccount = {
            id: Date.now().toString(),
            name: accountName,
            type: accountType,
            typeLabel: typeLabels[accountType] || "Lainnya",
            initialBalance: initialBalance,
            balance: initialBalance,
            color: accountColor,
            created: new Date().toISOString(),
            lastUpdated: new Date().toISOString(),
            transactionCount: 0,
          };

          // Add to accounts array
          accounts.push(newAccount);
          saveAccountsToStorage();

          // Update UI
          updateAccountSelector();
          updateAccountsDisplay();

          // Show success message
          alert(`Akun "${accountName}" berhasil ditambahkan!`);

          // Hide modal
          hideModal("addAccountModal");

          // Switch to new account if desired
          if (confirm("Apakah Anda ingin beralih ke akun ini sekarang?")) {
            switchAccount(newAccount.id);
          }
        } catch (error) {
          console.error("Error adding account:", error);
          alert("Terjadi kesalahan saat menambahkan akun");
        }
      }

      // Show edit account modal
      function showEditAccountModal(accountId) {
        const account = accounts.find((acc) => acc.id === accountId);
        if (!account) return;

        // Fill form with account data
        document.getElementById("editAccountId").value = account.id;
        document.getElementById("editAccountName").value = account.name;
        document.getElementById("editAccountType").value = account.type;

        // Set color
        document.getElementById("editSelectedColor").value = account.color;
        document
          .querySelectorAll("#editColorPicker .color-option")
          .forEach((opt) => {
            opt.classList.remove("selected");
            if (opt.dataset.color === account.color) {
              opt.classList.add("selected");
            }
          });

        // Disable delete button for default account
        document.getElementById("deleteAccountBtn").disabled =
          account.id === "default";

        // Show modal
        showModal("editAccountModal");
      }

      // Submit edit account form
      function submitEditAccountForm() {
        try {
          const accountId = document.getElementById("editAccountId").value;
          const accountName = document
            .getElementById("editAccountName")
            .value.trim();
          const accountType = document.getElementById("editAccountType").value;
          const accountColor =
            document.getElementById("editSelectedColor").value;

          // Validate
          if (!accountName) {
            alert("Nama akun tidak boleh kosong!");
            return;
          }

          // Find account
          const accountIndex = accounts.findIndex(
            (acc) => acc.id === accountId
          );
          if (accountIndex === -1) {
            alert("Akun tidak ditemukan!");
            return;
          }

          // Check if account name already exists (excluding current account)
          const duplicateAccount = accounts.find(
            (acc) =>
              acc.id !== accountId &&
              acc.name.toLowerCase() === accountName.toLowerCase()
          );

          if (duplicateAccount) {
            alert(`Akun dengan nama "${accountName}" sudah ada!`);
            return;
          }

          // Get type label
          const typeLabels = {
            cash: "Tunai",
            savings: "Tabungan",
            debit: "Kartu Debit",
            credit: "Kartu Kredit",
            investment: "Investasi",
            other: "Lainnya",
          };

          // Update account
          accounts[accountIndex].name = accountName;
          accounts[accountIndex].type = accountType;
          accounts[accountIndex].typeLabel =
            typeLabels[accountType] || "Lainnya";
          accounts[accountIndex].color = accountColor;
          accounts[accountIndex].lastUpdated = new Date().toISOString();

          // Save to storage
          saveAccountsToStorage();

          // Update UI
          updateAccountSelector();
          updateAccountsDisplay();

          // Show success message
          alert("Akun berhasil diperbarui!");

          // Hide modal
          hideModal("editAccountModal");
        } catch (error) {
          console.error("Error updating account:", error);
          alert("Terjadi kesalahan saat memperbarui akun");
        }
      }

      // Delete account
      function deleteAccount(accountId) {
        if (accountId === "default") {
          alert("Akun default tidak dapat dihapus!");
          return;
        }

        if (
          !confirm(
            "Apakah Anda yakin ingin menghapus akun ini? Semua transaksi di akun ini juga akan dihapus."
          )
        ) {
          return;
        }

        try {
          // Check if there are transactions
          const accountTransactions = transactions.filter(
            (t) => t.account === accountId
          );

          if (accountTransactions.length > 0) {
            if (
              !confirm(
                `Akun ini memiliki ${accountTransactions.length} transaksi. Yakin ingin menghapus?`
              )
            ) {
              return;
            }
          }

          // Remove account
          const accountIndex = accounts.findIndex(
            (acc) => acc.id === accountId
          );
          const accountName = accounts[accountIndex].name;
          accounts.splice(accountIndex, 1);

          // Remove transactions for this account
          transactions = transactions.filter((t) => t.account !== accountId);

          // If current account is being deleted, switch to default
          if (currentAccount === accountId) {
            currentAccount = "default";
            saveCurrentAccountToStorage();
          }

          // Save to storage
          saveAccountsToStorage();
          saveTransactionsToStorage();

          // Update UI
          updateAccountSelector();
          updateAccountsDisplay();
          updateDashboard();
          updateTransactionsTable();
          updateCategoryFilter();

          alert(`Akun "${accountName}" berhasil dihapus!`);
        } catch (error) {
          console.error("Error deleting account:", error);
          alert("Terjadi kesalahan saat menghapus akun");
        }
      }

      // Switch account
      function switchAccount(accountId) {
        try {
          currentAccount = accountId;
          saveCurrentAccountToStorage();
          updateAccountSelector();
          updateAccountsDisplay();
          updateDashboard();
          updateTransactionsTable();
          updateCategoryFilter();

          // Go to dashboard
          showPage("dashboard");
          updateBottomNavigation("dashboard");
          updateDesktopNavigation("dashboard");
        } catch (error) {
          console.error("Error switching account:", error);
          alert("Terjadi kesalahan saat mengganti akun");
        }
      }

      // Add new category
      function addNewCategory() {
        try {
          const categoryName = document
            .getElementById("newCategory")
            .value.trim();
          const categoryType = document.getElementById("categoryType").value;

          if (!categoryName) {
            alert("Nama kategori tidak boleh kosong!");
            return;
          }

          if (categories[categoryType].includes(categoryName)) {
            alert("Kategori sudah ada!");
            return;
          }

          categories[categoryType].push(categoryName);
          saveCategoriesToStorage();
          updateCategoriesDropdown();
          updateCategoriesDisplay();
          updateCategoryFilter();

          // Clear input
          document.getElementById("newCategory").value = "";

          alert(`Kategori "${categoryName}" berhasil ditambahkan!`);
        } catch (error) {
          console.error("Error adding category:", error);
          alert("Terjadi kesalahan saat menambahkan kategori");
        }
      }

      // Update categories display
      function updateCategoriesDisplay() {
        try {
          // Update income categories
          const incomeList = document.getElementById("incomeCategoriesList");
          incomeList.innerHTML = "";

          categories.income.forEach((category) => {
            incomeList.innerHTML += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-bottom: 1px solid #eee;">
                        <span>${category}</span>
                        <button class="btn-icon" onclick="deleteCategory('income', '${category}')" ${
              category === "Lainnya" ? "disabled" : ""
            }>
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
          });

          // Update expense categories
          const expenseList = document.getElementById("expenseCategoriesList");
          expenseList.innerHTML = "";

          categories.expense.forEach((category) => {
            expenseList.innerHTML += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-bottom: 1px solid #eee;">
                        <span>${category}</span>
                        <button class="btn-icon" onclick="deleteCategory('expense', '${category}')" ${
              category === "Lainnya" ? "disabled" : ""
            }>
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
          });
        } catch (error) {
          console.error("Error updating categories display:", error);
        }
      }

      // Delete category
      function deleteCategory(type, categoryName) {
        if (categoryName === "Lainnya") {
          alert('Kategori "Lainnya" tidak dapat dihapus!');
          return;
        }

        if (
          !confirm(
            `Apakah Anda yakin ingin menghapus kategori "${categoryName}"?`
          )
        ) {
          return;
        }

        try {
          // Remove category
          const categoryIndex = categories[type].indexOf(categoryName);
          categories[type].splice(categoryIndex, 1);
          saveCategoriesToStorage();
          updateCategoriesDisplay();
          updateCategoriesDropdown();
          updateCategoryFilter();

          // Update transactions with deleted category to "Lainnya"
          transactions.forEach((transaction) => {
            if (
              transaction.type === type &&
              transaction.category === categoryName
            ) {
              transaction.category = "Lainnya";
            }
          });
          saveTransactionsToStorage();

          alert(`Kategori "${categoryName}" berhasil dihapus!`);
        } catch (error) {
          console.error("Error deleting category:", error);
          alert("Terjadi kesalahan saat menghapus kategori");
        }
      }

      // Update date filters
      function updateDateFilters() {
        try {
          // Get unique years from transactions
          const years = [
            ...new Set(
              transactions
                .filter((t) => t.account === currentAccount)
                .map((t) => new Date(t.date).getFullYear())
            ),
          ].sort((a, b) => b - a);

          // Add current year if not present
          const currentYear = new Date().getFullYear();
          if (!years.includes(currentYear)) {
            years.unshift(currentYear);
          }

          // Update year filter
          const yearSelect = document.getElementById("reportYear");
          yearSelect.innerHTML = "";
          years.forEach((year) => {
            const option = document.createElement("option");
            option.value = year;
            option.textContent = year;
            yearSelect.appendChild(option);
          });
          yearSelect.value = currentYear;

          // Update month filter
          const monthSelect = document.getElementById("reportMonth");
          const monthNames = [
            "Januari",
            "Februari",
            "Maret",
            "April",
            "Mei",
            "Juni",
            "Juli",
            "Agustus",
            "September",
            "Oktober",
            "November",
            "Desember",
          ];
          monthSelect.innerHTML = "";
          monthNames.forEach((month, index) => {
            const option = document.createElement("option");
            option.value = index + 1;
            option.textContent = month;
            monthSelect.appendChild(option);
          });
          monthSelect.value = new Date().getMonth() + 1;
        } catch (error) {
          console.error("Error updating date filters:", error);
        }
      }

      // Generate report
      function generateReport() {
        try {
          const reportType = document.getElementById("reportType").value;
          const month = parseInt(document.getElementById("reportMonth").value);
          const year = parseInt(document.getElementById("reportYear").value);

          // Filter transactions
          let filteredTransactions = transactions.filter(
            (t) => t.account === currentAccount
          );

          if (reportType === "monthly") {
            filteredTransactions = filteredTransactions.filter((t) => {
              const transDate = new Date(t.date);
              return (
                transDate.getFullYear() === year &&
                transDate.getMonth() + 1 === month
              );
            });

            // Update report title
            const monthNames = [
              "Januari",
              "Februari",
              "Maret",
              "April",
              "Mei",
              "Juni",
              "Juli",
              "Agustus",
              "September",
              "Oktober",
              "November",
              "Desember",
            ];
            document.getElementById(
              "reportTitle"
            ).textContent = `Laporan Bulanan - ${
              monthNames[month - 1]
            } ${year}`;
          } else {
            filteredTransactions = filteredTransactions.filter((t) => {
              const transDate = new Date(t.date);
              return transDate.getFullYear() === year;
            });

            // Update report title
            document.getElementById(
              "reportTitle"
            ).textContent = `Laporan Tahunan - ${year}`;
          }

          // Prepare data for report
          const incomeByCategory = {};
          const expenseByCategory = {};

          filteredTransactions.forEach((transaction) => {
            if (transaction.type === "income") {
              if (!incomeByCategory[transaction.category]) {
                incomeByCategory[transaction.category] = 0;
              }
              incomeByCategory[transaction.category] += transaction.amount;
            } else {
              if (!expenseByCategory[transaction.category]) {
                expenseByCategory[transaction.category] = 0;
              }
              expenseByCategory[transaction.category] += transaction.amount;
            }
          });

          // Calculate totals
          const totalIncome = Object.values(incomeByCategory).reduce(
            (sum, amount) => sum + amount,
            0
          );
          const totalExpense = Object.values(expenseByCategory).reduce(
            (sum, amount) => sum + amount,
            0
          );
          const netBalance = totalIncome - totalExpense;

          // Update report table
          const tableBody = document.getElementById("reportTableBody");
          let html = "";

          // Add income rows
          Object.entries(incomeByCategory).forEach(([category, amount]) => {
            const percentage =
              totalIncome > 0 ? Math.round((amount / totalIncome) * 100) : 0;
            html += `
                    <tr>
                        <td>${category} (Pemasukan)</td>
                        <td>${
                          filteredTransactions.filter(
                            (t) =>
                              t.type === "income" && t.category === category
                          ).length
                        }</td>
                        <td>${formatCurrency(amount)}</td>
                        <td>${percentage}%</td>
                    </tr>
                `;
          });

          // Add expense rows
          Object.entries(expenseByCategory).forEach(([category, amount]) => {
            const percentage =
              totalExpense > 0 ? Math.round((amount / totalExpense) * 100) : 0;
            html += `
                    <tr>
                        <td>${category} (Pengeluaran)</td>
                        <td>${
                          filteredTransactions.filter(
                            (t) =>
                              t.type === "expense" && t.category === category
                          ).length
                        }</td>
                        <td>${formatCurrency(amount)}</td>
                        <td>${percentage}%</td>
                    </tr>
                `;
          });

          // Add summary row
          html += `
                <tr style="font-weight: bold; background-color: ${
                  theme === "dark" ? "#25304a" : "#f8f9fa"
                }">
                    <td>TOTAL</td>
                    <td>${filteredTransactions.length}</td>
                    <td>${formatCurrency(netBalance)}</td>
                    <td>${
                      totalIncome > 0
                        ? Math.round((netBalance / totalIncome) * 100)
                        : 0
                    }%</td>
                </tr>
            `;

          tableBody.innerHTML = html;

          // Update chart
          updateReportChart(filteredTransactions, reportType, month, year);
        } catch (error) {
          console.error("Error generating report:", error);
          alert("Terjadi kesalahan saat membuat laporan");
        }
      }

      // Update report chart
      function updateReportChart(transactions, reportType, month, year) {
        try {
          let labels = [];
          let incomeData = [];
          let expenseData = [];

          if (reportType === "monthly") {
            // Group by day
            const daysInMonth = new Date(year, month, 0).getDate();

            for (let day = 1; day <= daysInMonth; day++) {
              labels.push(`Hari ${day}`);

              const dayIncome = transactions
                .filter(
                  (t) =>
                    t.type === "income" && new Date(t.date).getDate() === day
                )
                .reduce((sum, t) => sum + t.amount, 0);

              const dayExpense = transactions
                .filter(
                  (t) =>
                    t.type === "expense" && new Date(t.date).getDate() === day
                )
                .reduce((sum, t) => sum + t.amount, 0);

              incomeData.push(dayIncome);
              expenseData.push(dayExpense);
            }
          } else {
            // Group by month
            const monthNames = [
              "Jan",
              "Feb",
              "Mar",
              "Apr",
              "Mei",
              "Jun",
              "Jul",
              "Agu",
              "Sep",
              "Okt",
              "Nov",
              "Des",
            ];
            labels = monthNames;

            for (let m = 0; m < 12; m++) {
              const monthIncome = transactions
                .filter(
                  (t) =>
                    t.type === "income" && new Date(t.date).getMonth() === m
                )
                .reduce((sum, t) => sum + t.amount, 0);

              const monthExpense = transactions
                .filter(
                  (t) =>
                    t.type === "expense" && new Date(t.date).getMonth() === m
                )
                .reduce((sum, t) => sum + t.amount, 0);

              incomeData.push(monthIncome);
              expenseData.push(monthExpense);
            }
          }

          // Update chart
          const reportCtx = document
            .getElementById("reportChart")
            .getContext("2d");
          if (reportChart) {
            reportChart.destroy();
          }

          reportChart = new Chart(reportCtx, {
            type: "bar",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "Pemasukan",
                  data: incomeData,
                  backgroundColor: "rgba(76, 201, 240, 0.7)",
                  borderColor: "rgba(76, 201, 240, 1)",
                  borderWidth: 1,
                },
                {
                  label: "Pengeluaran",
                  data: expenseData,
                  backgroundColor: "rgba(247, 37, 133, 0.7)",
                  borderColor: "rgba(247, 37, 133, 1)",
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function (value) {
                      return "Rp " + value.toLocaleString("id-ID");
                    },
                  },
                },
              },
              plugins: {
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      return (
                        context.dataset.label +
                        ": Rp " +
                        context.parsed.y.toLocaleString("id-ID")
                      );
                    },
                  },
                },
              },
            },
          });
        } catch (error) {
          console.error("Error updating report chart:", error);
        }
      }

      // Export to PDF
      async function exportToPDF() {
        try {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF("p", "mm", "a4");

          // Add title
          const reportTitle =
            document.getElementById("reportTitle").textContent;
          doc.setFontSize(18);
          doc.text(reportTitle, 105, 20, { align: "center" });

          // Add date
          const exportDate = new Date().toLocaleDateString("id-ID", {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
          });
          doc.setFontSize(11);
          doc.text(`Diekspor pada: ${exportDate}`, 105, 30, {
            align: "center",
          });

          // Add account info
          const currentAccountName =
            accounts.find((acc) => acc.id === currentAccount)?.name ||
            "Akun Utama";
          doc.text(`Akun: ${currentAccountName}`, 20, 40);

          // Add chart image
          const chartCanvas = document.getElementById("reportChart");
          const chartImage = await html2canvas(chartCanvas);
          doc.addImage(chartImage, "PNG", 20, 50, 170, 80);

          // Add table data
          const tableRows = document.querySelectorAll("#reportTableBody tr");
          let yPosition = 140;

          // Table header
          doc.setFillColor(67, 97, 238);
          doc.setTextColor(255, 255, 255);
          doc.rect(20, yPosition, 170, 10, "F");
          doc.text("Kategori", 22, yPosition + 7);
          doc.text("Jumlah", 100, yPosition + 7);
          doc.text("Total", 130, yPosition + 7);
          doc.text("%", 160, yPosition + 7);

          yPosition += 10;
          doc.setTextColor(0, 0, 0);

          // Table rows
          tableRows.forEach((row) => {
            if (yPosition > 270) {
              doc.addPage();
              yPosition = 20;
            }

            const cells = row.querySelectorAll("td");
            if (cells.length === 4) {
              doc.text(cells[0].textContent, 22, yPosition + 7);
              doc.text(cells[1].textContent, 100, yPosition + 7);
              doc.text(cells[2].textContent, 130, yPosition + 7);
              doc.text(cells[3].textContent, 160, yPosition + 7);
              yPosition += 10;
            }
          });

          // Save PDF
          doc.save(`Laporan Keuangan - ${reportTitle}.pdf`);
          alert("PDF berhasil diekspor!");
        } catch (error) {
          console.error("Error exporting to PDF:", error);
          alert("Terjadi kesalahan saat mengekspor PDF");
        }
      }

      // Reset all data
      function resetAllData() {
        if (
          !confirm(
            "Apakah Anda yakin ingin mereset semua data? Tindakan ini tidak dapat dibatalkan!"
          )
        ) {
          return;
        }

        try {
          // Reset all data
          transactions = [];
          accounts = [
            {
              id: "default",
              name: "Akun Utama",
              type: "cash",
              typeLabel: "Tunai",
              initialBalance: 0,
              balance: 0,
              color: "#4361ee",
              created: new Date().toISOString(),
              lastUpdated: new Date().toISOString(),
              transactionCount: 0,
            },
          ];
          categories = {
            income: ["Gaji", "Bonus", "Investasi", "Hadiah", "Lainnya"],
            expense: [
              "Makanan",
              "Transportasi",
              "Belanja",
              "Hiburan",
              "Kesehatan",
              "Pendidikan",
              "Lainnya",
            ],
          };
          currentAccount = "default";
          theme = "light";

          // Save to storage
          saveTransactionsToStorage();
          saveAccountsToStorage();
          saveCategoriesToStorage();
          saveCurrentAccountToStorage();
          saveThemeToStorage();

          // Update UI
          updateDashboard();
          updateTransactionsTable();
          updateAccountSelector();
          updateAccountsDisplay();
          updateCategoriesDropdown();
          updateCategoriesDisplay();
          updateTheme();

          alert("Semua data telah direset!");
        } catch (error) {
          console.error("Error resetting data:", error);
          alert("Terjadi kesalahan saat mereset data");
        }
      }

      // Helper functions
      function formatCurrency(amount) {
        return "Rp " + amount.toLocaleString("id-ID");
      }

      function formatDate(dateString) {
        try {
          const date = new Date(dateString);
          return date.toLocaleDateString("id-ID", {
            day: "2-digit",
            month: "short",
            year: "numeric",
          });
        } catch (error) {
          return dateString;
        }
      }

      function generateColors(count) {
        const colors = [];
        const hueStep = 360 / count;

        for (let i = 0; i < count; i++) {
          const hue = i * hueStep;
          colors.push(`hsl(${hue}, 70%, 60%)`);
        }

        return colors;
      }

      function openEditTransaction(id) {
  const trx = transactions.find(t => t.id === id);
  if (!trx) return;

  document.getElementById("editTransactionId").value = trx.id;
  document.getElementById("description").value = trx.description;
  document.getElementById("amount").value = trx.amount;
  document.getElementById("date").value = trx.date;

  document.querySelector(
    `input[name="type"][value="${trx.type}"]`
  ).checked = true;

  updateCategoriesDropdown();
  document.getElementById("category").value = trx.category;

  showModal("editTransactionModal");
}
    </script>

    <script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("/service-worker.js")
          .then(() => console.log("Service Worker registered"))
          .catch((err) => console.log("SW failed", err));
      }
    </script>
  </body>
</html>
